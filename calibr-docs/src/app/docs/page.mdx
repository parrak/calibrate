# üìö Calibr Product Documentation (Docs v0.2)

Calibr is a composable pricing control plane for omnichannel commerce. Merchants ingest live prices, stream competitive signals, apply guardrails, and roll out approved updates across Shopify, Amazon, and first-party storefronts with full governance.

## Table of contents

- [Platform overview](#platform-overview)
- [System architecture](#system-architecture)
- [Core pricing workflow](#core-pricing-workflow)
  - [1. Ingest price suggestions](#1-ingest-price-suggestions)
  - [2. Guardrail evaluation](#2-guardrail-evaluation)
  - [3. Review, approve, apply](#3-review-approve-apply)
  - [4. Channel synchronization](#4-channel-synchronization)
- [Merchant console](#merchant-console)
- [Analytics & copilot intelligence](#analytics--copilot-intelligence)
- [Channel connectors](#channel-connectors)
- [API surface](#api-surface)
- [Data model quick reference](#data-model-quick-reference)
- [Security & compliance](#security--compliance)
- [Operations & monitoring](#operations--monitoring)
- [Environments & onboarding](#environments--onboarding)
- [Testing & sandbox flows](#testing--sandbox-flows)

---

## Platform overview

- **Pricing guardrails:** Policy evaluation (floors, ceilings, % deltas, budgets) runs on every suggestion before it reaches a human or connector.
- **Governance workflow:** Price changes move through `PENDING ‚Üí APPROVED ‚Üí APPLIED`, with rollback support and per-role permissions.
- **Explainability:** Each action writes to an append-only audit/event log for traceability and downstream automation.
- **Composable services:** Dedicated packages handle AI suggestions, analytics rollups, connectors, monitoring, and security primitives.

Base URLs:

| Surface | URL |
|---------|-----|
| API     | `https://api.calibr.lat` |
| Console | `https://console.calibr.lat` |
| Docs    | `https://docs.calibr.lat` |

---

## System architecture

```text
calibrate/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ pricing-engine     # Guardrails, rule DSL, AI assisted suggestions
‚îÇ   ‚îú‚îÄ‚îÄ connectors         # Shopify + Amazon channel clients
‚îÇ   ‚îú‚îÄ‚îÄ analytics          # Daily snapshots, anomaly detection, insights
‚îÇ   ‚îú‚îÄ‚îÄ ai-engine          # Price recommendation models + explainers
‚îÇ   ‚îú‚îÄ‚îÄ monitor            # Request logging + metrics helpers
‚îÇ   ‚îú‚îÄ‚îÄ security           # HMAC signing, RBAC utilities, idempotency
‚îÇ   ‚îî‚îÄ‚îÄ db                 # Prisma schema, migrations, event log
‚îî‚îÄ‚îÄ apps/
    ‚îú‚îÄ‚îÄ api                # Next.js API routing layer
    ‚îú‚îÄ‚îÄ console            # Merchant console (Next.js App Router)
    ‚îú‚îÄ‚îÄ site               # Marketing site
    ‚îî‚îÄ‚îÄ docs               # (legacy) static docs, superseded by this site
```

Each app consumes shared packages via pnpm/Turborepo and deploys independently (Railway for API, Vercel for web surfaces).

---

## Core pricing workflow

### 1. Ingest price suggestions

External systems send signed suggestions to the webhook endpoint.

```bash
POST https://api.calibr.lat/api/v1/webhooks/price-suggestion
```

Payload fields:

- `idempotencyKey` ‚Äî dedupe per tenant.
- `skuCode`, `currency`, `proposedAmount` ‚Äî target SKU and price in minor units.
- `context` ‚Äî optional metadata (region, evidence URLs, experiment IDs).
- `source` ‚Äî `AI | RULE | MANUAL | CONNECTOR` for attribution.

Sign requests with `X-Calibr-Signature: t=<unix_ts>,v1=<sha256>` using your webhook secret. Clock skew tolerance is ¬±5 minutes.

### 2. Guardrail evaluation

`@calibr/pricing-engine` evaluates policy checks (floors/ceilings, % delta, daily budgets) and competitor-aware rules before a change enters the queue. The engine exposes helpers to preview rule impact, simulate connectors, and call out to AI suggestion services when needed.

### 3. Review, approve, apply

Humans (or automation) interact with the governance endpoints:

```
GET  /api/v1/price-changes?status=PENDING|APPROVED|APPLIED|REJECTED|FAILED|ROLLED_BACK
POST /api/v1/price-changes/:id/approve
POST /api/v1/price-changes/:id/apply
POST /api/v1/price-changes/:id/reject
POST /api/v1/price-changes/:id/rollback
```

Responses include policy results, connector sync states, and audit metadata so the console can reflect live status and guardrail explanations.

### 4. Channel synchronization

Connector workers push applied price changes back to commerce channels. Shopify updates return simulated variant payloads today; Amazon uses the SP-API wrapper and can operate in dry-run or live feed mode. Connector state is attached to the price change item (e.g., `SYNCING`, `SYNCED`, `ERROR`) for real-time visibility.

---

## Merchant console

- **Project switcher & onboarding:** Users create projects, validate slug availability, and attach connectors during onboarding flows.
- **Price change workspace:** Table view with status filters, full-text search, cursor pagination, and optimistic UI for approve/apply/reject/rollback.
- **Context drawer:** Diff cards show `from ‚Üí to` pricing, percentage deltas, policy check results, connector telemetry, and raw payload JSON.
- **Role-aware actions:** RBAC enforces VIEWER/EDITOR/ADMIN/OWNER capabilities‚Äîonly admins can apply or rollback.
- **AI explainability:** Inline AI copilot explains the rationale behind suggested deltas using guardrail + analytics context.

The console calls the same public API endpoints shown above, using the authenticated user‚Äôs API token and `Idempotency-Key` headers for mutations.

---

## Analytics & copilot intelligence

- **Daily snapshots:** `/api/v1/analytics-digest` aggregates project performance, revenue deltas, and top performers. It highlights anomalies such as 20% price spikes or margin compression and persists the digest for reporting.
- **Trend & anomaly helpers:** `@calibr/analytics` offers utilities for rolling aggregates, anomaly detection, and weekly insight digests.
- **Copilot query endpoint:** `/api/v1/copilot` turns natural-language prompts into tenant-scoped SQL, enforces RBAC, sanitises queries, logs every execution, and redacts sensitive fields before returning results.
- **AI price suggestions:** `@calibr/ai-engine` can generate candidate price moves with accompanying explanations that flow through the same guardrails as manual updates.

---

## Channel connectors

| Channel  | Status | Capabilities |
|----------|--------|--------------|
| Shopify  | ‚úÖ Stubbed write-back today. Logs variant updates, simulates Admin API responses, and lays groundwork for rate-limit aware retries. |
| Amazon   | ‚úÖ SP-API client with feeds, catalog, and competitive pricing helpers. Supports dry-run mode without credentials and feed submission when configured. |
| Custom / Other | üõ†Ô∏è Use the connector interfaces in `@calibr/connectors` or `@calibr/platform-connector` to build additional targets while reusing policy + audit plumbing. |

Each connector emits event log entries and updates the price change‚Äôs `connectorStatus` block so operators can monitor cross-channel propagation.

---

## API surface

| Endpoint | Description |
|----------|-------------|
| `POST /api/v1/webhooks/price-suggestion` | Accept signed price suggestions and enqueue them for policy evaluation. |
| `GET /api/v1/price-changes` | List price changes with filters (`status`, search `q`, cursor pagination) and role metadata. |
| `POST /api/v1/price-changes/:id/(approve|apply|reject|rollback)` | Transition a price change through the governance workflow. |
| `GET /api/v1/catalog` | Fetch products, SKUs, prices, connectors, and policy metadata for a project. |
| `GET /api/v1/audit` | Retrieve audit trail entries and explainability payloads for compliance reviews. |
| `GET /api/v1/competitors` | Manage competitor watchlists and latest scraped pricing. |
| `POST /api/v1/analytics-digest` | Generate daily digest (invoked by cron or manual trigger). |
| `POST /api/v1/copilot` | Execute AI-assisted analytics queries (read-only). |
| `GET /api/health`, `GET /api/healthz`, `GET /api/metrics`, `GET /api/metrics/enhanced` | Operational health and Prometheus-style metrics. |
| `POST /api/projects` | Create projects during onboarding; returns slug, tenant linkage, and membership. |
| `GET /api/projects` | List a user‚Äôs projects plus attached Shopify/Amazon integrations. |

Authentication uses session tokens issued from the console. Supply `Authorization: Bearer <token>` on API calls, plus `X-Calibr-Project` headers when acting on a specific workspace.

---

## Data model quick reference

Key Prisma models in `@calibr/db`:

- **Project & Tenant:** Multitenant scoping with owner memberships and connector associations.
- **Sku & Price:** Current catalog pricing, including cost metadata stored in JSON attributes.
- **PriceChange:** Tracks every proposed change, status, policy result, connector state, timestamps, and context payloads.
- **Audit & EventLog:** Append-only stores for explainability traces, webhook events, and connector sync results.
- **Competitor***:** Watchlists, competitor products, and captured competitor price points with timestamps.
- **AmazonIntegration / ShopifyIntegration:** OAuth tokens, sync status, and channel configuration metadata.
- **CopilotQueryLog:** History of NL‚ÜíSQL requests, resolved SQL, execution metrics, and schema versioning for analytics governance.

---

## Security & compliance

- **HMAC webhook signatures:** All incoming suggestions must be signed with tenant-specific secrets; signatures expire after 5 minutes.
- **RBAC enforcement:** API checks membership roles (VIEWER/EDITOR/ADMIN/OWNER) before allowing mutations or sensitive reads.
- **Idempotency:** Webhook payloads and mutation endpoints require `Idempotency-Key` headers; duplicates short-circuit safely.
- **Rate limiting:** In-memory defaults ship with 60 suggestions/minute per project, 100 governance actions per 5 minutes, and permissive health limits. Swap the store for Redis in production.
- **Security headers:** Responses include strict transport security, frame guards, and CORS allowances for console + docs hosts.
- **Audit log:** Every governance action, connector sync, and copilot query is persisted for compliance review and rollback tooling.

---

## Operations & monitoring

- **Request tracing:** `withMonitoring` wraps API routes with structured logging, request IDs, latency metrics, and error reporting via `@calibr/monitor`.
- **Metrics endpoints:** `/api/metrics` exposes Prometheus-style counters/histograms; `/api/metrics/enhanced` includes latency percentiles and connector stats.
- **Health checks:** `/api/health` (lightweight) and `/api/health/comprehensive` (DB + external dependencies) back deployment probes.
- **Cron jobs:** Vercel cron triggers analytics digest generation; additional admin routes surface background job state, alert backlogs, and security posture snapshots.

---

## Environments & onboarding

1. **Create an account** at the console (`https://console.calibr.lat`).
2. **Create a project:** Choose a slug, invite teammates, and connect Shopify/Amazon when ready.
3. **Retrieve credentials:** Copy your webhook secret and API token from project settings.
4. **Send suggestions:** Use the webhook recipe above or the SDK helpers in `@calibr/security` to sign requests.
5. **Review & ship:** Approve or auto-apply guardrail-safe changes, monitor connector statuses, and schedule analytics digests.

Staging environments live at `staging-*.calibr.lat` with mirrored functionality for sandbox testing.

---

## Testing & sandbox flows

- **Sample curl:** Try the quickstart snippet from the webhook section to submit a synthetic price change.
- **Guardrail validation:** Adjust proposed amounts to trigger `policyResult.ok=false` and observe pending status + audit entry.
- **Rollback drills:** Apply a change, then POST to `/api/v1/price-changes/:id/rollback` to verify connector compensation logic.
- **Copilot QA:** Ask `/api/v1/copilot` natural-language questions (e.g., ‚ÄúWhich SKUs had margin compression yesterday?‚Äù) to confirm RBAC-scoped analytics.
- **Analytics digest:** Manually POST to `/api/v1/analytics-digest?project=<slug>` in staging to preview the daily summary payload.

Need deeper integration support? Reach out via the console help beacon or email support@calibr.lat.
