generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AmazonCompetitivePrice {
  id               String   @id
  asin             String
  marketplaceId    String
  lowestPriceCents Int?
  buyBoxPriceCents Int?
  offerCount       Int      @default(0)
  data             Json?
  retrievedAt      DateTime @default(now()) @db.Timestamptz(6)

  @@index([asin, marketplaceId], map: "AmazonCompetitivePrice_asin_marketplace_idx")
  @@index([retrievedAt])
}

model AmazonIntegration {
  id             String    @id
  projectId      String
  sellerId       String
  marketplaceId  String    @default("ATVPDKIKX0DER")
  region         String    @default("us-east-1")
  refreshToken   String
  accessToken    String?
  tokenExpiresAt DateTime?
  installedAt    DateTime  @default(now())
  isActive       Boolean   @default(true)
  lastSyncAt     DateTime?
  syncStatus     String?
  syncError      String?
  Project        Project   @relation(fields: [projectId], references: [id])

  @@unique([projectId, sellerId])
  @@index([projectId])
  @@index([sellerId])
}

model AmazonWatchlist {
  asin          String
  marketplaceId String
  active        Boolean  @default(true)
  notes         String?
  addedAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @db.Timestamptz(6)

  @@id([asin, marketplaceId])
  @@unique([asin, marketplaceId], map: "AmazonWatchlist_asin_marketplace_unique")
}

model Competitor {
  id                String              @id
  tenantId          String
  projectId         String
  name              String
  domain            String
  channel           String
  isActive          Boolean             @default(true)
  lastChecked       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  Project           Project             @relation(fields: [projectId], references: [id])
  Tenant            Tenant              @relation(fields: [tenantId], references: [id])
  CompetitorProduct CompetitorProduct[]

  @@index([tenantId, projectId])
}

model CompetitorPrice {
  id                String            @id
  productId         String
  amount            Int
  currency          String
  channel           String?
  isOnSale          Boolean           @default(false)
  saleEndsAt        DateTime?
  stockStatus       String?
  createdAt         DateTime          @default(now())
  CompetitorProduct CompetitorProduct @relation(fields: [productId], references: [id])

  @@index([createdAt])
  @@index([productId, createdAt])
}

model CompetitorProduct {
  id              String            @id
  competitorId    String
  skuId           String?
  name            String
  skuCode         String?
  url             String
  imageUrl        String?
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  CompetitorPrice CompetitorPrice[]
  Competitor      Competitor        @relation(fields: [competitorId], references: [id])
  Sku             Sku?              @relation(fields: [skuId], references: [id])

  @@index([competitorId, skuCode])
}

model CompetitorRule {
  id          String   @id
  tenantId    String
  projectId   String
  name        String
  description String?
  isActive    Boolean  @default(true)
  rules       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Project     Project  @relation(fields: [projectId], references: [id])
  Tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, projectId])
}

model Customer {
  id        String   @id
  tenantId  String
  email     String
  name      String?
  org       String?
  createdAt DateTime @default(now())
  Tenant    Tenant   @relation(fields: [tenantId], references: [id])
  Quote     Quote[]
}

model Event {
  id        String   @id
  tenantId  String?
  projectId String?
  kind      String
  payload   Json
  createdAt DateTime @default(now())
  Project   Project? @relation(fields: [projectId], references: [id])
  Tenant    Tenant?  @relation(fields: [tenantId], references: [id])
}

model Membership {
  id        String      @id
  userId    String
  projectId String
  role      ProjectRole @default(VIEWER)
  Project   Project     @relation(fields: [projectId], references: [id])
  User      User        @relation(fields: [userId], references: [id])

  @@unique([userId, projectId])
}

model Policy {
  id        String   @id
  tenantId  String
  projectId String   @unique
  autoApply Boolean  @default(false)
  rules     Json
  createdAt DateTime @default(now())
  updatedAt DateTime
  Project   Project  @relation(fields: [projectId], references: [id])
  Tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model Price {
  id           String         @id
  skuId        String
  currency     String
  billingCycle String?
  unit         String?
  amount       Int
  status       Status         @default(ACTIVE)
  Sku          Sku            @relation(fields: [skuId], references: [id])
  PriceVersion PriceVersion[]

  @@unique([skuId, currency], map: "skuId_currency")
  @@index([skuId, currency])
}

model PriceChange {
  id           String            @id
  tenantId     String
  projectId    String
  skuId        String
  source       String
  fromAmount   Int
  toAmount     Int
  currency     String
  context      Json?
  status       PriceChangeStatus @default(PENDING)
  policyResult Json?
  approvedBy   String?
  appliedAt    DateTime?
  connectorStatus Json?
  createdAt    DateTime          @default(now())

  @@index([tenantId, projectId, status])
}

model PriceVersion {
  id        String   @id
  priceId   String
  amount    Int
  note      String?
  createdAt DateTime @default(now())
  Price     Price    @relation(fields: [priceId], references: [id])
}

model Product {
  id        String   @id
  tenantId  String
  projectId String
  name      String
  code      String
  status    Status   @default(DRAFT)
  createdAt DateTime @default(now())
  Project   Project  @relation(fields: [projectId], references: [id])
  Tenant    Tenant   @relation(fields: [tenantId], references: [id])
  Sku       Sku[]

  @@unique([tenantId, projectId, code], map: "tenantId_projectId_code")
}

model Project {
  id                 String               @id
  tenantId           String
  name               String
  slug               String               @unique
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  amazonIntegrations String[]
  AmazonIntegration  AmazonIntegration[]
  Competitor         Competitor[]
  CompetitorRule     CompetitorRule[]
  Event              Event[]
  Membership         Membership[]
  Policy             Policy?
  Product            Product[]
  Tenant             Tenant               @relation(fields: [tenantId], references: [id])
  ShopifyIntegration ShopifyIntegration[]
}

model Quote {
  id          String      @id
  tenantId    String
  customerId  String
  status      QuoteStatus @default(DRAFT)
  currency    String
  subtotal    Int         @default(0)
  total       Int         @default(0)
  meta        Json?
  createdAt   DateTime    @default(now())
  checkoutUrl String?
  Customer    Customer    @relation(fields: [customerId], references: [id])
  QuoteItem   QuoteItem[]
}

model QuoteItem {
  id         String   @id
  quoteId    String
  skuId      String
  name       String
  qty        Int
  unitAmount Int
  createdAt  DateTime @default(now())
  Quote      Quote    @relation(fields: [quoteId], references: [id])
}

model ShopifyIntegration {
  id                         String                       @id
  projectId                  String
  shopDomain                 String                       @unique
  accessToken                String
  scope                      String
  installedAt                DateTime                     @default(now())
  isActive                   Boolean                      @default(true)
  lastSyncAt                 DateTime?
  syncStatus                 String?
  syncError                  String?
  Project                    Project                      @relation(fields: [projectId], references: [id])
  ShopifyWebhookSubscription ShopifyWebhookSubscription[]

  @@index([projectId])
  @@index([shopDomain])
}

model ShopifyWebhookSubscription {
  id                 String             @id
  integrationId      String
  topic              String
  address            String
  webhookId          String             @unique
  createdAt          DateTime           @default(now())
  isActive           Boolean            @default(true)
  ShopifyIntegration ShopifyIntegration @relation(fields: [integrationId], references: [id])

  @@index([integrationId])
  @@index([webhookId])
}

model Sku {
  id                String              @id
  productId         String
  name              String
  code              String
  attributes        Json?
  status            Status              @default(DRAFT)
  CompetitorProduct CompetitorProduct[]
  Price             Price[]
  Product           Product             @relation(fields: [productId], references: [id])

  @@unique([productId, code], map: "productId_code")
}

model Tenant {
  id             String           @id
  name           String
  createdAt      DateTime         @default(now())
  Competitor     Competitor[]
  CompetitorRule CompetitorRule[]
  Customer       Customer[]
  Event          Event[]
  Policy         Policy[]
  Product        Product[]
  Project        Project[]
  User           User[]
}

model User {
  id           String       @id
  email        String       @unique
  name         String?
  role         Role         @default(MEMBER)
  tenantId     String
  createdAt    DateTime     @default(now())
  passwordHash String?
  Membership   Membership[]
  Tenant       Tenant       @relation(fields: [tenantId], references: [id])
}

enum PriceChangeStatus {
  PENDING
  APPROVED
  REJECTED
  APPLIED
  FAILED
  ROLLED_BACK
}

enum ProjectRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum QuoteStatus {
  DRAFT
  ISSUED
  ACCEPTED
  EXPIRED
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum Status {
  DRAFT
  ACTIVE
  ARCHIVED
}
